<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Switch Admin Panel</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00276b;
            --secondary: #0004ff;
            --accent: #d0d707;
            --dark: #00d0ff;
            --light: #f8f9fa;
            --success: #32f800;
            --warning: #ffcc00;
            --danger: #dc3545;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: #f5f7fa; color: #333; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: var(--primary); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .logo { font-size: 28px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--accent); }
        .subtitle { opacity: 0.8; margin-top: 5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; margin: 10px 0; }
        .stat-label { font-size: 14px; opacity: 0.7; }
        .stat-card.total-users { border-left: 5px solid var(--primary); }
        .stat-card.total-cs { border-left: 5px solid var(--accent); }
        .stat-card.total-usd { border-left: 5px solid var(--success); }
        .stat-card.pending-withdrawals { border-left: 5px solid var(--warning); }
        .tabs { display: flex; background: white; border-radius: 10px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .tab { padding: 15px 20px; cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .tab.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .content-box { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        tr:hover { background: #f8f9fa; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: var(--dark); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .search-box { margin-bottom: 20px; display: flex; gap: 10px; }
        .search-box input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; }
        .user-detail { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .user-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .user-stat { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close { font-size: 24px; cursor: pointer; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 5px; color: white; z-index: 1001; opacity: 0; transform: translateY(-20px); transition: all 0.3s; }
        .notification.show { opacity: 1; transform: translateY(0); }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--danger); }
        .notification.info { background: var(--primary); }
        .pagination { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .pagination button { padding: 8px 15px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 5px; }
        .pagination button.active { background: var(--primary); color: white; border-color: var(--primary); }
        .transaction-history { margin-top: 20px; }
        .transaction-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-type { font-weight: bold; }
        .transaction-amount { font-weight: bold; }
        .transaction-date { color: #777; font-size: 12px; }
        .deposit { color: var(--success); }
        .withdrawal { color: var(--danger); }
        .adjustment { color: var(--warning); }
        .filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 12px; margin-bottom: 5px; }
        .tab-sub { display: flex; margin-bottom: 15px; }
        .tab-sub button { padding: 8px 15px; background: #f0f0f0; border: none; cursor: pointer; }
        .tab-sub button.active { background: var(--primary); color: white; }
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stats-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stats-card h4 { margin: 0 0 10px 0; font-size: 14px; color: #777; }
        .stats-card .value { font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-coins"></i>
                <span>Coin Switch Admin Panel</span>
            </div>
            <p class="subtitle">Manage users, withdrawals, deposits, and system settings</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card total-users">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="total-users">0</div>
            </div>
            <div class="stat-card total-cs">
                <div class="stat-label">Total CS Tokens</div>
                <div class="stat-value" id="total-cs">0</div>
            </div>
            <div class="stat-card total-usd">
                <div class="stat-label">Total USD Balance</div>
                <div class="stat-value" id="total-usd">$0</div>
            </div>
            <div class="stat-card pending-withdrawals">
                <div class="stat-label">Pending Withdrawals</div>
                <div class="stat-value" id="pending-withdrawals">0</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="users">Users</div>
            <div class="tab" data-tab="deposits">Deposits</div>
            <div class="tab" data-tab="withdrawals">Withdrawals</div>
            <div class="tab" data-tab="transactions">Transactions</div>
            <div class="tab" data-tab="settings">Settings</div>
        </div>

        <div class="tab-content active" id="users-tab">
            <div class="search-box">
                <input type="text" id="user-search" placeholder="Search by User ID...">
                <button class="btn btn-primary" id="search-btn">Search</button>
                <button class="btn btn-info" id="refresh-users-btn">Refresh</button>
            </div>
            
            <div id="user-detail-view" style="display: none;">
                <div class="user-detail">
                    <h3>User Details: <span id="user-id"></span></h3>
                    <div class="user-stats">
                        <div class="user-stat">
                            <div>CS Balance</div>
                            <div class="stat-value" id="user-cs-balance">0</div>
                        </div>
                        <div class="user-stat">
                            <div>USD Balance</div>
                            <div class="stat-value" id="user-usd-balance">$0</div>
                        </div>
                        <div class="user-stat">
                            <div>Hash Power</div>
                            <div class="stat-value" id="user-hash-power">0</div>
                        </div>
                        <div class="user-stat">
                            <div>Referrals</div>
                            <div class="stat-value" id="user-referrals">0</div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="edit-user-btn">Edit Balances</button>
                        <button class="btn btn-success" id="add-deposit-btn">Add Deposit</button>
                        <button class="btn btn-warning" id="process-withdrawal-btn">Process Withdrawal</button>
                        <button class="btn btn-info" id="view-transactions-btn">View Transactions</button>
                        <button class="btn btn-danger" id="reset-user-btn">Reset User</button>
                        <button class="btn" id="back-to-list-btn">Back to List</button>
                    </div>
                </div>
            </div>

            <div id="user-list-view">
                <div class="content-box">
                    <h3>All Users</h3>
                    <div class="filters">
                        <div class="filter-group">
                            <label>Sort By</label>
                            <select id="user-sort">
                                <option value="userId">User ID</option>
                                <option value="csBalance">CS Balance (High to Low)</option>
                                <option value="usdBalance">USD Balance (High to Low)</option>
                                <option value="referralCount">Referral Count</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Items Per Page</label>
                            <select id="user-per-page">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>CS Balance</th>
                                <th>USD Balance</th>
                                <th>Hash Power</th>
                                <th>Referrals</th>
                                <th>Last Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                    <div class="pagination" id="users-pagination">
                        <!-- Pagination will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="deposits-tab">
            <div class="content-box">
                <h3>Deposit Management</h3>
                <div class="tab-sub">
                    <button class="active" data-deposit-tab="pending">Pending Deposits</button>
                    <button data-deposit-tab="approved">Approved Deposits</button>
                    <button data-deposit-tab="rejected">Rejected Deposits</button>
                    <button data-deposit-tab="all">All Deposits</button>
                </div>
                <div class="filters">
                    <div class="filter-group">
                        <label>From Date</label>
                        <input type="date" id="deposit-from-date">
                    </div>
                    <div class="filter-group">
                        <label>To Date</label>
                        <input type="date" id="deposit-to-date">
                    </div>
                    <div class="filter-group">
                        <label>User ID</label>
                        <input type="text" id="deposit-user-filter" placeholder="Filter by user">
                    </div>
                    <div class="filter-group">
                        <label>Min Amount</label>
                        <input type="number" id="deposit-min-amount" placeholder="Min amount">
                    </div>
                    <div class="filter-group">
                        <label style="visibility: hidden;">Apply</label>
                        <button class="btn btn-primary" id="apply-deposit-filters">Apply Filters</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Amount</th>
                            <th>Transaction ID</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="deposits-table-body">
                        <!-- Deposits will be populated here -->
                    </tbody>
                </table>
                <div class="pagination" id="deposits-pagination">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="withdrawals-tab">
            <div class="content-box">
                <h3>Withdrawal Requests</h3>
                <div class="tab-sub">
                    <button class="active" data-withdrawal-tab="pending">Pending</button>
                    <button data-withdrawal-tab="approved">Approved</button>
                    <button data-withdrawal-tab="rejected">Rejected</button>
                    <button data-withdrawal-tab="all">All</button>
                </div>
                <div class="filters">
                    <div class="filter-group">
                        <label>From Date</label>
                        <input type="date" id="withdrawal-from-date">
                    </div>
                    <div class="filter-group">
                        <label>To Date</label>
                        <input type="date" id="withdrawal-to-date">
                    </div>
                    <div class="filter-group">
                        <label>User ID</label>
                        <input type="text" id="withdrawal-user-filter" placeholder="Filter by user">
                    </div>
                    <div class="filter-group">
                        <label>Min Amount</label>
                        <input type="number" id="withdrawal-min-amount" placeholder="Min amount">
                    </div>
                    <div class="filter-group">
                        <label style="visibility: hidden;">Apply</label>
                        <button class="btn btn-primary" id="apply-withdrawal-filters">Apply Filters</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Amount</th>
                            <th>USDT Address</th>
                            <th>Status</th>
                            <th>Request Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table-body">
                        <!-- Withdrawals will be populated here -->
                    </tbody>
                </table>
                <div class="pagination" id="withdrawals-pagination">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="transactions-tab">
            <div class="content-box">
                <h3>Transaction History</h3>
                <div class="filters">
                    <div class="filter-group">
                        <label>Transaction Type</label>
                        <select id="transaction-type">
                            <option value="all">All</option>
                            <option value="deposit">Deposit</option>
                            <option value="withdrawal">Withdrawal</option>
                            <option value="manual_adjustment">Manual Adjustment</option>
                            <option value="purchase">Package Purchase</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>From Date</label>
                        <input type="date" id="transaction-from-date">
                    </div>
                    <div class="filter-group">
                        <label>To Date</label>
                        <input type="date" id="transaction-to-date">
                    </div>
                    <div class="filter-group">
                        <label>User ID</label>
                        <input type="text" id="transaction-user-filter" placeholder="Filter by user">
                    </div>
                    <div class="filter-group">
                        <label style="visibility: hidden;">Apply</label>
                        <button class="btn btn-primary" id="apply-transaction-filters">Apply Filters</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Details</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body">
                        <!-- Transactions will be populated here -->
                    </tbody>
                </table>
                <div class="pagination" id="transactions-pagination">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
        </div>

        <div class="tab-content" id="settings-tab">
            <div class="content-box">
                <h3>System Settings</h3>
                <div class="stats-cards">
                    <div class="stats-card">
                        <h4>CS Token Price</h4>
                        <div class="value" id="current-cs-price">$0.05</div>
                    </div>
                    <div class="stats-card">
                        <h4>Tap Reward</h4>
                        <div class="value" id="current-tap-reward">0.5 CS</div>
                    </div>
                    <div class="stats-card">
                        <h4>Minimum Withdrawal</h4>
                        <div class="value" id="current-min-withdrawal">$10.00</div>
                    </div>
                    <div class="stats-card">
                        <h4>Withdrawal Fee</h4>
                        <div class="value" id="current-withdrawal-fee">1%</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="cs-token-price">CS Token Price (USD)</label>
                    <input type="number" id="cs-token-price" step="0.01" value="0.05">
                </div>
                <div class="form-group">
                    <label for="tap-reward">Tap Reward (CS)</label>
                    <input type="number" id="tap-reward" step="0.1" value="0.5">
                </div>
                <div class="form-group">
                    <label for="min-withdrawal">Minimum Withdrawal (USD)</label>
                    <input type="number" id="min-withdrawal" step="1" value="10">
                </div>
                <div class="form-group">
                    <label for="withdrawal-fee">Withdrawal Fee (%)</label>
                    <input type="number" id="withdrawal-fee" step="0.1" value="1">
                </div>
                <div class="form-group">
                    <label for="admin-password">Admin Password</label>
                    <input type="password" id="admin-password" placeholder="Enter password to save changes">
                </div>
                <button class="btn btn-primary" id="save-settings-btn">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="edit-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User Balances</h3>
                <span class="close">&times;</span>
            </div>
            <div class="form-group">
                <label for="edit-cs-balance">CS Balance</label>
                <input type="number" id="edit-cs-balance" step="0.01">
            </div>
            <div class="form-group">
                <label for="edit-usd-balance">USD Balance</label>
                <input type="number" id="edit-usd-balance" step="0.01">
            </div>
            <div class="form-group">
                <label for="edit-hash-power">Hash Power</label>
                <input type="number" id="edit-hash-power" step="1">
            </div>
            <div class="form-group">
                <label for="edit-referral-count">Referral Count</label>
                <input type="number" id="edit-referral-count" step="1">
            </div>
            <div class="form-group">
                <label for="edit-reason">Reason for adjustment</label>
                <textarea id="edit-reason" placeholder="Explain why you're making these changes"></textarea>
            </div>
            <button class="btn btn-primary" id="save-user-btn">Save Changes</button>
        </div>
    </div>

    <!-- Add Deposit Modal -->
    <div class="modal" id="add-deposit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Deposit for <span id="deposit-user-id"></span></h3>
                <span class="close">&times;</span>
            </div>
            <div class="form-group">
                <label for="deposit-amount">Amount (USD)</label>
                <input type="number" id="deposit-amount" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="deposit-transaction-id">Transaction ID (Optional)</label>
                <input type="text" id="deposit-transaction-id" placeholder="Enter transaction ID if available">
            </div>
            <div class="form-group">
                <label for="deposit-notes">Notes</label>
                <textarea id="deposit-notes" placeholder="Additional notes about this deposit"></textarea>
            </div>
            <button class="btn btn-success" id="confirm-deposit-btn">Add Deposit</button>
        </div>
    </div>

    <!-- Process Withdrawal Modal -->
    <div class="modal" id="process-withdrawal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Process Withdrawal for <span id="withdrawal-user-id"></span></h3>
                <span class="close">&times;</span>
            </div>
            <div class="form-group">
                <label for="withdrawal-amount">Amount (USD)</label>
                <input type="number" id="withdrawal-amount" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="withdrawal-address">USDT Address</label>
                <input type="text" id="withdrawal-address" placeholder="Enter USDT address">
            </div>
            <div class="form-group">
                <label for="withdrawal-transaction-id">Transaction ID (Optional)</label>
                <input type="text" id="withdrawal-transaction-id" placeholder="Enter transaction ID if processed">
            </div>
            <div class="form-group">
                <label for="withdrawal-notes">Notes</label>
                <textarea id="withdrawal-notes" placeholder="Additional notes about this withdrawal"></textarea>
            </div>
            <button class="btn btn-warning" id="confirm-withdrawal-btn">Process Withdrawal</button>
        </div>
    </div>

    <!-- View Transactions Modal -->
    <div class="modal" id="view-transactions-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Transaction History for <span id="transactions-user-id"></span></h3>
                <span class="close">&times;</span>
            </div>
            <div class="transaction-history" id="user-transactions-list">
                <!-- Transactions will be populated here -->
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <span id="notification-text"></span>
    </div>

    <script>
        // Firebase configuration - Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentPage = 1;
        const usersPerPage = 10;
        let totalUsers = 0;
        let currentEditingUserId = null;

        // DOM Elements
        const dom = {
            totalUsers: document.getElementById('total-users'),
            totalCs: document.getElementById('total-cs'),
            totalUsd: document.getElementById('total-usd'),
            pendingWithdrawals: document.getElementById('pending-withdrawals'),
            usersTableBody: document.getElementById('users-table-body'),
            withdrawalsTableBody: document.getElementById('withdrawals-table-body'),
            depositsTableBody: document.getElementById('deposits-table-body'),
            transactionsTableBody: document.getElementById('transactions-table-body'),
            usersPagination: document.getElementById('users-pagination'),
            withdrawalsPagination: document.getElementById('withdrawals-pagination'),
            depositsPagination: document.getElementById('deposits-pagination'),
            transactionsPagination: document.getElementById('transactions-pagination'),
            userSearch: document.getElementById('user-search'),
            searchBtn: document.getElementById('search-btn'),
            refreshUsersBtn: document.getElementById('refresh-users-btn'),
            userDetailView: document.getElementById('user-detail-view'),
            userListView: document.getElementById('user-list-view'),
            userId: document.getElementById('user-id'),
            userCsBalance: document.getElementById('user-cs-balance'),
            userUsdBalance: document.getElementById('user-usd-balance'),
            userHashPower: document.getElementById('user-hash-power'),
            userReferrals: document.getElementById('user-referrals'),
            editUserBtn: document.getElementById('edit-user-btn'),
            addDepositBtn: document.getElementById('add-deposit-btn'),
            processWithdrawalBtn: document.getElementById('process-withdrawal-btn'),
            viewTransactionsBtn: document.getElementById('view-transactions-btn'),
            resetUserBtn: document.getElementById('reset-user-btn'),
            backToListBtn: document.getElementById('back-to-list-btn'),
            editUserModal: document.getElementById('edit-user-modal'),
            addDepositModal: document.getElementById('add-deposit-modal'),
            processWithdrawalModal: document.getElementById('process-withdrawal-modal'),
            viewTransactionsModal: document.getElementById('view-transactions-modal'),
            editCsBalance: document.getElementById('edit-cs-balance'),
            editUsdBalance: document.getElementById('edit-usd-balance'),
            editHashPower: document.getElementById('edit-hash-power'),
            editReferralCount: document.getElementById('edit-referral-count'),
            editReason: document.getElementById('edit-reason'),
            saveUserBtn: document.getElementById('save-user-btn'),
            depositUserId: document.getElementById('deposit-user-id'),
            depositAmount: document.getElementById('deposit-amount'),
            depositTransactionId: document.getElementById('deposit-transaction-id'),
            depositNotes: document.getElementById('deposit-notes'),
            confirmDepositBtn: document.getElementById('confirm-deposit-btn'),
            withdrawalUserId: document.getElementById('withdrawal-user-id'),
            withdrawalAmount: document.getElementById('withdrawal-amount'),
            withdrawalAddress: document.getElementById('withdrawal-address'),
            withdrawalTransactionId: document.getElementById('withdrawal-transaction-id'),
            withdrawalNotes: document.getElementById('withdrawal-notes'),
            confirmWithdrawalBtn: document.getElementById('confirm-withdrawal-btn'),
            transactionsUserId: document.getElementById('transactions-user-id'),
            userTransactionsList: document.getElementById('user-transactions-list'),
            closeModal: document.querySelectorAll('.close'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notification-text'),
            csTokenPrice: document.getElementById('cs-token-price'),
            tapReward: document.getElementById('tap-reward'),
            minWithdrawal: document.getElementById('min-withdrawal'),
            withdrawalFee: document.getElementById('withdrawal-fee'),
            adminPassword: document.getElementById('admin-password'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            currentCsPrice: document.getElementById('current-cs-price'),
            currentTapReward: document.getElementById('current-tap-reward'),
            currentMinWithdrawal: document.getElementById('current-min-withdrawal'),
            currentWithdrawalFee: document.getElementById('current-withdrawal-fee'),
            userSort: document.getElementById('user-sort'),
            userPerPage: document.getElementById('user-per-page')
        };

        // Show notification
        function showNotification(message, type = 'success') {
            dom.notificationText.textContent = message;
            dom.notification.className = `notification ${type} show`;
            setTimeout(() => {
                dom.notification.classList.remove('show');
            }, 3000);
        }

        // Load statistics
        async function loadStatistics() {
            try {
                // Get total users
                const usersSnapshot = await db.collection('users').get();
                totalUsers = usersSnapshot.size;
                dom.totalUsers.textContent = totalUsers.toLocaleString();
                
                // Calculate total CS and USD
                let totalCs = 0;
                let totalUsd = 0;
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    totalCs += user.csBalance || 0;
                    totalUsd += user.usdBalance || 0;
                });
                
                dom.totalCs.textContent = totalCs.toFixed(2);
                dom.totalUsd.textContent = '$' + totalUsd.toFixed(2);
                
                // Get pending withdrawals
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'pending')
                    .get();
                
                dom.pendingWithdrawals.textContent = withdrawalsSnapshot.size;
            } catch (error) {
                console.error("Error loading statistics:", error);
                showNotification("Error loading statistics", "error");
            }
        }

        // Load users with pagination
        async function loadUsers(page = 1) {
            try {
                const itemsPerPage = parseInt(dom.userPerPage.value) || usersPerPage;
                const startAt = (page - 1) * itemsPerPage;
                const sortField = dom.userSort.value;
                
                let usersQuery = db.collection('users')
                    .orderBy(sortField, sortField === 'userId' ? 'asc' : 'desc')
                    .startAt(startAt)
                    .limit(itemsPerPage);
                
                const usersSnapshot = await usersQuery.get();
                
                dom.usersTableBody.innerHTML = '';
                
                if (usersSnapshot.empty) {
                    dom.usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No users found</td></tr>';
                    return;
                }
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const lastActive = user.lastPassiveUpdate ? new Date(user.lastPassiveUpdate).toLocaleDateString() : 'N/A';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.userId}</td>
                        <td>${user.csBalance?.toFixed(4) || '0.0000'} CS</td>
                        <td>$${user.usdBalance?.toFixed(2) || '0.00'}</td>
                        <td>${user.hashPower || '0'} H/s</td>
                        <td>${user.referralCount || '0'}</td>
                        <td>${lastActive}</td>
                        <td>
                            <button class="btn btn-primary view-user" data-id="${user.userId}">View</button>
                        </td>
                    `;
                    dom.usersTableBody.appendChild(tr);
                });
                
                // Setup pagination
                setupPagination('users', page, totalUsers, itemsPerPage);
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-user').forEach(btn => {
                    btn.addEventListener('click', () => {
                        viewUser(btn.dataset.id);
                    });
                });
            } catch (error) {
                console.error("Error loading users:", error);
                showNotification("Error loading users", "error");
            }
        }

        // View user details
        async function viewUser(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (!userDoc.exists) {
                    showNotification("User not found", "error");
                    return;
                }
                
                const user = userDoc.data();
                
                dom.userId.textContent = userId;
                dom.userCsBalance.textContent = user.csBalance?.toFixed(4) || '0.0000';
                dom.userUsdBalance.textContent = '$' + (user.usdBalance?.toFixed(2) || '0.00');
                dom.userHashPower.textContent = user.hashPower || '0';
                dom.userReferrals.textContent = user.referralCount || '0';
                
                currentEditingUserId = userId;
                
                dom.userListView.style.display = 'none';
                dom.userDetailView.style.display = 'block';
            } catch (error) {
                console.error("Error viewing user:", error);
                showNotification("Error loading user details", "error");
            }
        }

        // Load withdrawals
        async function loadWithdrawals(page = 1) {
            try {
                const statusFilter = document.querySelector('[data-withdrawal-tab].active')?.dataset.withdrawalTab || 'pending';
                const fromDate = dom.withdrawalFromDate.value;
                const toDate = dom.withdrawalToDate.value;
                const userFilter = dom.withdrawalUserFilter.value;
                const minAmount = dom.withdrawalMinAmount.value;
                
                let withdrawalsQuery = db.collection('withdrawals');
                
                if (statusFilter !== 'all') {
                    withdrawalsQuery = withdrawalsQuery.where('status', '==', statusFilter);
                }
                
                if (fromDate) {
                    const fromDateObj = new Date(fromDate);
                    withdrawalsQuery = withdrawalsQuery.where('createdAt', '>=', fromDateObj);
                }
                
                if (toDate) {
                    const toDateObj = new Date(toDate);
                    toDateObj.setHours(23, 59, 59, 999);
                    withdrawalsQuery = withdrawalsQuery.where('createdAt', '<=', toDateObj);
                }
                
                if (userFilter) {
                    withdrawalsQuery = withdrawalsQuery.where('userId', '==', userFilter);
                }
                
                withdrawalsQuery = withdrawalsQuery.orderBy('createdAt', 'desc');
                
                const withdrawalsSnapshot = await withdrawalsQuery.get();
                
                dom.withdrawalsTableBody.innerHTML = '';
                
                if (withdrawalsSnapshot.empty) {
                    dom.withdrawalsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No withdrawal requests found</td></tr>';
                    return;
                }
                
                let filteredWithdrawals = [];
                withdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    if (!minAmount || withdrawal.amount >= parseFloat(minAmount)) {
                        filteredWithdrawals.push({ id: doc.id, ...withdrawal });
                    }
                });
                
                const itemsPerPage = 10;
                const startIndex = (page - 1) * itemsPerPage;
                const paginatedWithdrawals = filteredWithdrawals.slice(startIndex, startIndex + itemsPerPage);
                
                paginatedWithdrawals.forEach(withdrawal => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${withdrawal.userId}</td>
                        <td>$${withdrawal.amount?.toFixed(2)}</td>
                        <td>${withdrawal.usdtAddress}</td>
                        <td>${withdrawal.status}</td>
                        <td>${withdrawal.createdAt ? withdrawal.createdAt.toDate().toLocaleDateString() : 'N/A'}</td>
                        <td>
                            ${withdrawal.status === 'pending' ? 
                                `<button class="btn btn-success approve-withdrawal" data-id="${withdrawal.id}">Approve</button>
                                 <button class="btn btn-danger reject-withdrawal" data-id="${withdrawal.id}">Reject</button>` : 
                                'Processed'}
                        </td>
                    `;
                    dom.withdrawalsTableBody.appendChild(tr);
                });
                
                // Setup pagination
                setupPagination('withdrawals', page, filteredWithdrawals.length, itemsPerPage);
                
                // Add event listeners to action buttons
                document.querySelectorAll('.approve-withdrawal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        processWithdrawal(btn.dataset.id, 'approved');
                    });
                });
                
                document.querySelectorAll('.reject-withdrawal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        processWithdrawal(btn.dataset.id, 'rejected');
                    });
                });
            } catch (error) {
                console.error("Error loading withdrawals:", error);
                showNotification("Error loading withdrawals", "error");
            }
        }

        // Process withdrawal
        async function processWithdrawal(withdrawalId, status) {
            try {
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: status,
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification(`Withdrawal ${status} successfully`);
                loadWithdrawals();
                loadStatistics();
            } catch (error) {
                console.error("Error processing withdrawal:", error);
                showNotification("Error processing withdrawal", "error");
            }
        }

        // Setup pagination
        function setupPagination(type, currentPage, totalItems, itemsPerPage = 10) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationElement = dom[`${type}Pagination`];
            
            paginationElement.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'Previous';
                prevBtn.addEventListener('click', () => {
                    if (type === 'users') loadUsers(currentPage - 1);
                    else if (type === 'withdrawals') loadWithdrawals(currentPage - 1);
                });
                paginationElement.appendChild(prevBtn);
            }
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.addEventListener('click', () => {
                    if (type === 'users') loadUsers(i);
                    else if (type === 'withdrawals') loadWithdrawals(i);
                });
                paginationElement.appendChild(pageBtn);
            }
            
            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next';
                nextBtn.addEventListener('click', () => {
                    if (type === 'users') loadUsers(currentPage + 1);
                    else if (type === 'withdrawals') loadWithdrawals(currentPage + 1);
                });
                paginationElement.appendChild(nextBtn);
            }
        }

        // Initialize admin panel
        function init() {
            // Load initial data
            loadStatistics();
            loadUsers();
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                    
                    if (tab.dataset.tab === 'withdrawals') {
                        loadWithdrawals();
                    } else if (tab.dataset.tab === 'users') {
                        loadUsers();
                    }
                });
            });
            
            // Search user
            dom.searchBtn.addEventListener('click', () => {
                const searchTerm = dom.userSearch.value.trim();
                if (searchTerm) {
                    viewUser(searchTerm);
                }
            });
            
            // Refresh users
            dom.refreshUsersBtn.addEventListener('click', () => {
                loadUsers();
                loadStatistics();
            });
            
            // Back to list
            dom.backToListBtn.addEventListener('click', () => {
                dom.userDetailView.style.display = 'none';
                dom.userListView.style.display = 'block';
            });
            
            // Edit user modal
            dom.editUserBtn.addEventListener('click', () => {
                dom.editCsBalance.value = parseFloat(dom.userCsBalance.textContent);
                dom.editUsdBalance.value = parseFloat(dom.userUsdBalance.textContent.replace('$', ''));
                dom.editHashPower.value = parseInt(dom.userHashPower.textContent);
                dom.editReferralCount.value = parseInt(dom.userReferrals.textContent);
                dom.editUserModal.style.display = 'flex';
            });
            
            // Add deposit modal
            dom.addDepositBtn.addEventListener('click', () => {
                dom.depositUserId.textContent = currentEditingUserId;
                dom.depositAmount.value = '';
                dom.depositTransactionId.value = '';
                dom.depositNotes.value = '';
                dom.addDepositModal.style.display = 'flex';
            });
            
            // Process withdrawal modal
            dom.processWithdrawalBtn.addEventListener('click', () => {
                dom.withdrawalUserId.textContent = currentEditingUserId;
                dom.withdrawalAmount.value = '';
                dom.withdrawalAddress.value = '';
                dom.withdrawalTransactionId.value = '';
                dom.withdrawalNotes.value = '';
                dom.processWithdrawalModal.style.display = 'flex';
            });
            
            // View transactions modal
            dom.viewTransactionsBtn.addEventListener('click', async () => {
                dom.transactionsUserId.textContent = currentEditingUserId;
                dom.userTransactionsList.innerHTML = '<p>Loading transactions...</p>';
                dom.viewTransactionsModal.style.display = 'flex';
                
                // Load user transactions
                try {
                    const transactionsSnapshot = await db.collection('transactions')
                        .where('userId', '==', currentEditingUserId)
                        .orderBy('date', 'desc')
                        .limit(20)
                        .get();
                    
                    dom.userTransactionsList.innerHTML = '';
                    
                    if (transactionsSnapshot.empty) {
                        dom.userTransactionsList.innerHTML = '<p>No transactions found</p>';
                        return;
                    }
                    
                    transactionsSnapshot.forEach(doc => {
                        const transaction = doc.data();
                        const transactionEl = document.createElement('div');
                        transactionEl.className = 'transaction-item';
                        
                        let amountClass = '';
                        if (transaction.type === 'deposit') amountClass = 'deposit';
                        else if (transaction.type === 'withdrawal') amountClass = 'withdrawal';
                        else if (transaction.type === 'manual_adjustment') amountClass = 'adjustment';
                        
                        transactionEl.innerHTML = `
                            <div>
                                <div class="transaction-type">${transaction.type.replace('_', ' ').toUpperCase()}</div>
                                <div class="transaction-date">${transaction.date.toDate().toLocaleString()}</div>
                                ${transaction.notes ? `<div>${transaction.notes}</div>` : ''}
                            </div>
                            <div class="transaction-amount ${amountClass}">
                                ${transaction.currency === 'USD' ? '$' : ''}${transaction.amount} ${transaction.currency}
                            </div>
                        `;
                        
                        dom.userTransactionsList.appendChild(transactionEl);
                    });
                } catch (error) {
                    console.error("Error loading transactions:", error);
                    dom.userTransactionsList.innerHTML = '<p>Error loading transactions</p>';
                }
            });
            
            // Close modals
            dom.closeModal.forEach(closeBtn => {
                closeBtn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Save user changes
            dom.saveUserBtn.addEventListener('click', async () => {
                try {
                    const csBalance = parseFloat(dom.editCsBalance.value);
                    const usdBalance = parseFloat(dom.editUsdBalance.value);
                    const hashPower = parseInt(dom.editHashPower.value);
                    const referralCount = parseInt(dom.editReferralCount.value);
                    const reason = dom.editReason.value;
                    
                    if (isNaN(csBalance) || isNaN(usdBalance) || isNaN(hashPower) || isNaN(referralCount)) {
                        showNotification("Please enter valid values", "error");
                        return;
                    }
                    
                    if (!reason) {
                        showNotification("Please provide a reason for this adjustment", "error");
                        return;
                    }
                    
                    // Record the transaction
                    await db.collection('transactions').add({
                        userId: currentEditingUserId,
                        type: 'manual_adjustment',
                        amount: usdBalance,
                        currency: 'USD',
                        notes: `Manual adjustment: ${reason}`,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update user data
                    await db.collection('users').doc(currentEditingUserId).update({
                        csBalance: csBalance,
                        usdBalance: usdBalance,
                        hashPower: hashPower,
                        referralCount: referralCount
                    });
                    
                    showNotification("User updated successfully");
                    dom.editUserModal.style.display = 'none';
                    viewUser(currentEditingUserId); // Refresh user details
                    loadStatistics(); // Refresh statistics
                } catch (error) {
                    console.error("Error updating user:", error);
                    showNotification("Error updating user", "error");
                }
            });
            
            // Confirm deposit
            dom.confirmDepositBtn.addEventListener('click', async () => {
                try {
                    const amount = parseFloat(dom.depositAmount.value);
                    const transactionId = dom.depositTransactionId.value;
                    const notes = dom.depositNotes.value;
                    
                    if (isNaN(amount) || amount <= 0) {
                        showNotification("Please enter a valid amount", "error");
                        return;
                    }
                    
                    // Get current user data
                    const userDoc = await db.collection('users').doc(currentEditingUserId).get();
                    if (!userDoc.exists) {
                        showNotification("User not found", "error");
                        return;
                    }
                    
                    const user = userDoc.data();
                    const newBalance = (user.usdBalance || 0) + amount;
                    
                    // Record the transaction
                    await db.collection('transactions').add({
                        userId: currentEditingUserId,
                        type: 'deposit',
                        amount: amount,
                        currency: 'USD',
                        transactionId: transactionId,
                        notes: notes,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update user balance
                    await db.collection('users').doc(currentEditingUserId).update({
                        usdBalance: newBalance
                    });
                    
                    showNotification(`Deposit of $${amount} added successfully`);
                    dom.addDepositModal.style.display = 'none';
                    viewUser(currentEditingUserId); // Refresh user details
                    loadStatistics(); // Refresh statistics
                } catch (error) {
                    console.error("Error adding deposit:", error);
                    showNotification("Error adding deposit", "error");
                }
            });
            
            // Confirm withdrawal
            dom.confirmWithdrawalBtn.addEventListener('click', async () => {
                try {
                    const amount = parseFloat(dom.withdrawalAmount.value);
                    const address = dom.withdrawalAddress.value;
                    const transactionId = dom.withdrawalTransactionId.value;
                    const notes = dom.withdrawalNotes.value;
                    
                    if (isNaN(amount) || amount <= 0) {
                        showNotification("Please enter a valid amount", "error");
                        return;
                    }
                    
                    if (!address) {
                        showNotification("Please enter a USDT address", "error");
                        return;
                    }
                    
                    // Get current user data
                    const userDoc = await db.collection('users').doc(currentEditingUserId).get();
                    if (!userDoc.exists) {
                        showNotification("User not found", "error");
                        return;
                    }
                    
                    const user = userDoc.data();
                    
                    if (amount > user.usdBalance) {
                        showNotification("Insufficient balance", "error");
                        return;
                    }
                    
                    const newBalance = user.usdBalance - amount;
                    
                    // Record the transaction
                    await db.collection('transactions').add({
                        userId: currentEditingUserId,
                        type: 'withdrawal',
                        amount: amount,
                        currency: 'USD',
                        address: address,
                        transactionId: transactionId,
                        notes: notes,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create withdrawal record
                    await db.collection('withdrawals').add({
                        userId: currentEditingUserId,
                        amount: amount,
                        usdtAddress: address,
                        status: 'approved',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        processedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update user balance
                    await db.collection('users').doc(currentEditingUserId).update({
                        usdBalance: newBalance
                    });
                    
                    showNotification(`Withdrawal of $${amount} processed successfully`);
                    dom.processWithdrawalModal.style.display = 'none';
                    viewUser(currentEditingUserId); // Refresh user details
                    loadStatistics(); // Refresh statistics
                } catch (error) {
                    console.error("Error processing withdrawal:", error);
                    showNotification("Error processing withdrawal", "error");
                }
            });
            
            // Reset user
            dom.resetUserBtn.addEventListener('click', async () => {
                if (confirm("Are you sure you want to reset this user? This will set all balances to zero.")) {
                    try {
                        await db.collection('users').doc(currentEditingUserId).update({
                            csBalance: 0,
                            usdBalance: 0,
                            hashPower: 10,
                            dailyUsdReward: 0,
                            purchasedPackages: [],
                            referralCsEarnings: 0,
                            minedUsdBalance: 0
                        });
                        
                        showNotification("User reset successfully");
                        viewUser(currentEditingUserId); // Refresh user details
                        loadStatistics(); // Refresh statistics
                    } catch (error) {
                        console.error("Error resetting user:", error);
                        showNotification("Error resetting user", "error");
                    }
                }
            });
            
            // Save settings
            dom.saveSettingsBtn.addEventListener('click', async () => {
                try {
                    // In a real application, you would save these settings to Firebase
                    // and have the client app read them
                    showNotification("Settings saved (Note: In a real app, these would be saved to Firebase)");
                } catch (error) {
                    console.error("Error saving settings:", error);
                    showNotification("Error saving settings", "error");
                }
            });
            
            // Apply withdrawal filters
            dom.applyWithdrawalFilters.addEventListener('click', () => {
                loadWithdrawals();
            });
            
            // User sort and per page changes
            dom.userSort.addEventListener('change', () => {
                loadUsers();
            });
            
            dom.userPerPage.addEventListener('change', () => {
                loadUsers();
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>